# 🧪 后端API测试指南

## 🚀 快速开始

### 步骤1: 启动后端服务器

```bash
cd "C:\Users\plant\Desktop\Rust区块链\Rust-Blockchain-Secure-Wallet"

# 使用主菜单启动
bash wallet_tools.sh
# 选择 "1. 启动服务器"
```

服务器会在 `http://localhost:8888` 启动

---

## 🔑 API认证信息

```
API密钥: testnet_api_key_51a69b550a2c4149
认证方式: Authorization头部(原始密钥,无Bearer前缀)
```

---

## 📋 API端点测试

### 1. 健康检查

```bash
curl http://localhost:8888/api/health
```

**预期响应:**
```json
{
  "status": "ok",
  "timestamp": "2025-10-25T...",
  "version": "0.1.0"
}
```

---

### 2. 获取钱包列表

```bash
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets
```

**预期响应:**
```json
[]
或
[
  {
    "id": "wallet_1",
    "name": "wallet_1",
    "quantum_safe": false
  }
]
```

---

### 3. 创建钱包

```bash
curl -X POST http://localhost:8888/api/wallets \
  -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "test_wallet",
    "description": "测试钱包",
    "quantum_safe": false
  }'
```

**预期响应:**
```json
{
  "id": "test_wallet",
  "name": "test_wallet",
  "quantum_safe": false
}
```

---

### 4. 查询余额

```bash
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  "http://localhost:8888/api/wallets/test_wallet/balance?network=eth"
```

**预期响应:**
```json
{
  "balance": "0.000000000000000000",
  "network": "eth",
  "symbol": "ETH"
}
```

---

### 5. 交易历史

```bash
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets/test_wallet/history
```

**预期响应:**
```json
{
  "transactions": []
}
```

---

### 6. 网络状态/指标

```bash
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/metrics
```

**预期响应:**
```
# HELP defi_hot_wallet_requests_total Total number of requests
# TYPE defi_hot_wallet_requests_total counter
defi_hot_wallet_requests_total 0
```

---

## 🧪 自动化测试

### 快速测试(推荐)

```bash
bash quick_test.sh
```

**功能:**
- 自动启动服务器(如果未运行)
- 测试6个API端点
- 显示成功率

**输出示例:**
```
[1] 测试: 健康检查
    ✅ 成功

[2] 测试: 钱包列表
    ✅ 成功

...

📊 测试结果
总测试数: 6
成功: 6 ✅
失败: 0 ❌
成功率: 100%
```

---

### 长期稳定性测试

```bash
bash week_automated_test_final.sh
```

**选择测试模式:**
1. 快速测试 (5分钟间隔, 1小时) ⭐推荐
2. 短期测试 (10分钟间隔, 6小时)
3. 中期测试 (30分钟间隔, 1天)
4. 长期测试 (1小时间隔, 3天)
5. 完整测试 (2小时间隔, 7天)
6. 自定义

---

## 🔧 使用Postman测试

### 导入配置

创建 `postman_collection.json`:

```json
{
  "info": {
    "name": "DeFi热钱包API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "健康检查",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:8888/api/health",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8888",
          "path": ["api", "health"]
        }
      }
    },
    {
      "name": "获取钱包列表",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "testnet_api_key_51a69b550a2c4149",
            "type": "text"
          }
        ],
        "url": {
          "raw": "http://localhost:8888/api/wallets",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8888",
          "path": ["api", "wallets"]
        }
      }
    },
    {
      "name": "创建钱包",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "testnet_api_key_51a69b550a2c4149",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"test_wallet\",\n  \"description\": \"测试钱包\",\n  \"quantum_safe\": false\n}"
        },
        "url": {
          "raw": "http://localhost:8888/api/wallets",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8888",
          "path": ["api", "wallets"]
        }
      }
    }
  ]
}
```

---

## 🚨 常见错误处理

### 错误1: Unauthorized (401)

**错误响应:**
```json
{
  "error": "Unauthorized",
  "code": "AUTH_FAILED"
}
```

**原因:** API密钥错误或缺失

**解决:**
```bash
# 确保使用正确的API密钥
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets
```

---

### 错误2: Connection Refused

**错误信息:**
```
curl: (7) Failed to connect to localhost port 8888
```

**原因:** 服务器未启动

**解决:**
```bash
bash wallet_tools.sh
# 选择 "1. 启动服务器"
```

---

### 错误3: CORS Error

**错误信息:**
```
Access-Control-Allow-Origin header is missing
```

**原因:** CORS配置问题

**解决:**
- 后端已配置CORS允许 `http://localhost:3000`
- 如果前端在其他端口,修改环境变量:
```bash
export CORS_ALLOW_ORIGIN="http://localhost:3001"
bash restart_server.sh
```

---

## 📊 性能测试

### 使用Apache Bench

```bash
# 测试健康检查端点
ab -n 1000 -c 10 http://localhost:8888/api/health

# 测试钱包列表(需要API密钥)
ab -n 1000 -c 10 \
  -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets
```

---

## 🔍 调试技巧

### 1. 查看服务器日志

```bash
bash view_server_logs.sh
# 选择 "5. 实时跟踪日志"
```

### 2. 检查服务器状态

```bash
bash wallet_tools.sh
# 选择 "4. 查看服务器状态"
```

### 3. 详细请求日志

```bash
# 使用curl的verbose模式
curl -v -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets
```

---

## 📝 测试检查清单

测试前确认:

- [ ] 服务器在8888端口运行
- [ ] 可以访问健康检查端点
- [ ] API密钥正确: `testnet_api_key_51a69b550a2c4149`
- [ ] 数据库文件存在: `./data/testnet_wallet.db`
- [ ] 日志正常输出

---

## 🎯 完整测试流程

```bash
# 1. 启动服务器
bash wallet_tools.sh
# 选择 "1. 启动服务器"

# 2. 等待15秒

# 3. 运行快速测试
bash quick_test.sh

# 4. 查看结果
# 应该看到 6/6 测试通过

# 5. 查看日志
bash view_server_logs.sh
```

---

## 📖 相关文档

- `服务器配置信息.md` - 完整配置说明
- `CORS配置说明.md` - CORS详细配置
- `startup-and-testing-guide.md` - 启动指南
- `命令速查表.md` - 快速命令参考

---

**开始测试后端API!** 🚀

