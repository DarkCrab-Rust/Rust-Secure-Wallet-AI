# 🧪 测试覆盖率提升计划

## 📊 当前状态分析

```bash
# 运行覆盖率检查
cargo tarpaulin --out Html --output-dir coverage

# 当前估计覆盖率: ~65%
# 目标覆盖率: 90%+
```

---

## 🎯 Week 1: 核心钱包管理模块测试

### Day 1-2: 钱包生命周期测试

**测试文件**: `tests/core_wallet_lifecycle_tests.rs`

```rust
#[cfg(test)]
mod wallet_lifecycle_tests {
    use super::*;

    #[tokio::test]
    async fn test_create_wallet_success() {
        // 正常创建
    }

    #[tokio::test]
    async fn test_create_wallet_duplicate_name() {
        // 重复名称应失败
    }

    #[tokio::test]
    async fn test_create_wallet_invalid_name() {
        // 无效名称应失败
    }

    #[tokio::test]
    async fn test_create_wallet_quantum_safe() {
        // 量子安全钱包
    }

    #[tokio::test]
    async fn test_delete_wallet_with_transactions() {
        // 有交易的钱包删除
    }

    #[tokio::test]
    async fn test_wallet_backup_and_restore() {
        // 备份恢复流程
    }

    #[tokio::test]
    async fn test_concurrent_wallet_operations() {
        // 并发操作测试
    }
}
```

### Day 3-4: 密钥管理测试

**测试文件**: `tests/crypto_key_management_tests.rs`

```rust
#[tokio::test]
async fn test_key_derivation_consistency() {
    // 相同种子应产生相同密钥
}

#[tokio::test]
async fn test_key_rotation_success() {
    // 密钥轮换
}

#[tokio::test]
async fn test_key_zeroization() {
    // 内存清零验证
}

#[tokio::test]
async fn test_hd_wallet_derivation_paths() {
    // BIP32/BIP44路径测试
}
```

### Day 5: 交易签名测试

**测试文件**: `tests/crypto_signing_tests.rs`

```rust
#[tokio::test]
async fn test_sign_transaction_ethereum() {
    // 以太坊交易签名
}

#[tokio::test]
async fn test_sign_transaction_solana() {
    // Solana交易签名
}

#[tokio::test]
async fn test_signature_verification() {
    // 签名验证
}

#[tokio::test]
async fn test_multisig_signing_flow() {
    // 多签流程
}
```

---

## 🎯 Week 2: API和存储模块测试

### Day 1-2: API端点测试

**测试文件**: `tests/api_comprehensive_tests.rs`

```rust
// 每个端点需要测试:
// 1. 成功场景
// 2. 认证失败
// 3. 参数验证失败
// 4. 资源不存在
// 5. 并发请求
// 6. 速率限制

#[tokio::test]
async fn test_create_wallet_api_all_scenarios() {
    // POST /api/wallets - 所有场景
}

#[tokio::test]
async fn test_get_balance_api_all_scenarios() {
    // GET /api/wallets/:name/balance - 所有场景
}

// ... 其他端点
```

### Day 3-4: 存储层测试

**测试文件**: `tests/storage_comprehensive_tests.rs`

```rust
#[tokio::test]
async fn test_database_connection_pool() {
    // 连接池测试
}

#[tokio::test]
async fn test_transaction_atomicity() {
    // 事务原子性
}

#[tokio::test]
async fn test_concurrent_writes() {
    // 并发写入
}

#[tokio::test]
async fn test_data_integrity_after_crash() {
    // 崩溃后数据完整性
}
```

### Day 5: 边界条件测试

```rust
#[tokio::test]
async fn test_large_transaction_amount() {
    // 大额交易
}

#[tokio::test]
async fn test_empty_wallet_name() {
    // 空钱包名
}

#[tokio::test]
async fn test_unicode_wallet_name() {
    // Unicode字符
}

#[tokio::test]
async fn test_max_wallets_limit() {
    // 钱包数量限制
}
```

---

## 🎯 Week 3: 集成测试和性能测试

### Day 1-3: 端到端集成测试

**测试文件**: `tests/integration_end_to_end_tests.rs`

```rust
#[tokio::test]
async fn test_complete_wallet_workflow() {
    // 1. 创建钱包
    // 2. 查询余额
    // 3. 发送交易
    // 4. 查看历史
    // 5. 备份钱包
    // 6. 删除钱包
}

#[tokio::test]
async fn test_multi_user_scenarios() {
    // 多用户并发场景
}

#[tokio::test]
async fn test_bridge_workflow() {
    // 跨链桥接完整流程
}
```

### Day 4-5: 性能基准测试

**测试文件**: `benches/performance_benchmarks.rs`

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn bench_wallet_creation(c: &mut Criterion) {
    c.bench_function("create_wallet", |b| {
        b.iter(|| {
            // 钱包创建性能
        })
    });
}

fn bench_transaction_signing(c: &mut Criterion) {
    c.bench_function("sign_transaction", |b| {
        b.iter(|| {
            // 交易签名性能
        })
    });
}

criterion_group!(benches, bench_wallet_creation, bench_transaction_signing);
criterion_main!(benches);
```

---

## 📈 目标指标

```
模块                当前覆盖率    目标覆盖率
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
core/wallet_manager   70%   →    95%+
crypto/*              60%   →    90%+
api/*                 75%   →    95%+
storage/*             65%   →    90%+
blockchain/*          50%   →    85%+
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总体                  ~65%  →    90%+
```

---

## 🛠️ 工具和命令

```bash
# 1. 运行所有测试
cargo test --all-features

# 2. 生成覆盖率报告
cargo tarpaulin --out Html --output-dir coverage

# 3. 运行特定模块测试
cargo test --test core_wallet_lifecycle_tests

# 4. 性能基准测试
cargo bench

# 5. 并发测试
cargo test -- --test-threads=1  # 单线程（集成测试）
cargo test -- --test-threads=20 # 20线程（单元测试）
```

---

## ✅ 完成标准

- [ ] 所有模块覆盖率 > 90%
- [ ] 所有API端点有完整测试
- [ ] 所有边界条件有测试
- [ ] 性能基准建立
- [ ] 集成测试覆盖主要流程
- [ ] 生成HTML覆盖率报告

