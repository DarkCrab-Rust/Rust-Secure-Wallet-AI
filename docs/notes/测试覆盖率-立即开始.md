# 🚀 测试覆盖率提升 - 立即开始

## 📊 当前状态

```
覆盖率: ~65%
目标:   90%+
时间:   3周
```

---

## 🎯 优先级总览

| 优先级 | 模块 | 当前 | 目标 | 重要性 | Week |
|--------|------|------|------|--------|------|
| **P0** | 核心钱包管理 | ~70% | 95% | ⭐⭐⭐⭐⭐ | Week 1 |
| **P0** | 加密签名验证 | ~60% | 90% | ⭐⭐⭐⭐⭐ | Week 1 |
| **P0** | API认证授权 | ~75% | 95% | ⭐⭐⭐⭐⭐ | Week 1 |
| **P1** | 存储层 | ~65% | 90% | ⭐⭐⭐⭐ | Week 2 |
| **P1** | API端点完整性 | ~70% | 95% | ⭐⭐⭐⭐ | Week 2 |
| **P1** | 密钥管理轮换 | ~50% | 85% | ⭐⭐⭐⭐ | Week 2 |
| **P2** | 区块链交互 | ~45% | 75% | ⭐⭐⭐ | Week 3 |
| **P2** | 边界条件 | ~50% | 80% | ⭐⭐⭐ | Week 3 |
| **P2** | 多签/量子安全 | ~40% | 75% | ⭐⭐⭐ | Week 3 |

---

## ⚡ Week 1 行动计划（现在开始！）

### **Day 1-2: 核心钱包管理**

#### 创建测试文件
```bash
cat > tests/week1_wallet_core_tests.rs << 'EOF'
//! Week 1: 核心钱包管理优先级测试

#[cfg(test)]
mod wallet_core_priority_tests {
    use defi_hot_wallet::core::wallet_manager::WalletManager;
    use defi_hot_wallet::core::config::WalletConfig;
    use defi_hot_wallet::test_env;
    use tempfile::tempdir;
    
    /// 辅助函数：创建测试用的WalletManager
    async fn create_test_manager() -> WalletManager {
        test_env::set_test_env();
        let temp_dir = tempdir().unwrap();
        std::env::set_current_dir(temp_dir.path()).unwrap();
        
        let mut config = WalletConfig::default();
        config.storage.database_url = "sqlite://test_wallets.db?mode=rwc".to_string();
        
        WalletManager::new(&config).await.unwrap()
    }
    
    // ===== 钱包创建测试 =====
    
    #[tokio::test]
    async fn test_create_wallet_success() {
        let manager = create_test_manager().await;
        let result = manager.create_wallet("test_wallet", false).await;
        assert!(result.is_ok(), "创建钱包应该成功");
    }
    
    #[tokio::test]
    async fn test_create_wallet_duplicate_fails() {
        let manager = create_test_manager().await;
        manager.create_wallet("duplicate", false).await.unwrap();
        
        let result = manager.create_wallet("duplicate", false).await;
        assert!(result.is_err(), "重复名称应该失败");
    }
    
    #[tokio::test]
    async fn test_create_wallet_empty_name_fails() {
        let manager = create_test_manager().await;
        let result = manager.create_wallet("", false).await;
        assert!(result.is_err(), "空名称应该失败");
    }
    
    #[tokio::test]
    async fn test_create_wallet_special_chars_fail() {
        let manager = create_test_manager().await;
        
        let invalid_names = vec!["wallet-name", "wallet name", "wallet@123", "钱包"];
        for name in invalid_names {
            let result = manager.create_wallet(name, false).await;
            assert!(result.is_err(), "特殊字符名称应该失败: {}", name);
        }
    }
    
    #[tokio::test]
    async fn test_create_wallet_quantum_safe() {
        let manager = create_test_manager().await;
        let result = manager.create_wallet("quantum_wallet", true).await;
        assert!(result.is_ok(), "量子安全钱包应该成功");
    }
    
    // ===== 钱包删除测试 =====
    
    #[tokio::test]
    async fn test_delete_wallet_success() {
        let manager = create_test_manager().await;
        manager.create_wallet("to_delete", false).await.unwrap();
        
        let result = manager.delete_wallet("to_delete").await;
        assert!(result.is_ok(), "删除钱包应该成功");
    }
    
    #[tokio::test]
    async fn test_delete_nonexistent_wallet_fails() {
        let manager = create_test_manager().await;
        let result = manager.delete_wallet("nonexistent").await;
        assert!(result.is_err(), "删除不存在的钱包应该失败");
    }
    
    // ===== 钱包列表测试 =====
    
    #[tokio::test]
    async fn test_list_wallets_empty() {
        let manager = create_test_manager().await;
        let wallets = manager.list_wallets().await.unwrap();
        assert_eq!(wallets.len(), 0, "初始列表应该为空");
    }
    
    #[tokio::test]
    async fn test_list_wallets_multiple() {
        let manager = create_test_manager().await;
        
        manager.create_wallet("wallet1", false).await.unwrap();
        manager.create_wallet("wallet2", false).await.unwrap();
        manager.create_wallet("wallet3", false).await.unwrap();
        
        let wallets = manager.list_wallets().await.unwrap();
        assert_eq!(wallets.len(), 3, "应该有3个钱包");
    }
    
    // ===== 并发测试 =====
    
    #[tokio::test]
    async fn test_concurrent_wallet_creation() {
        let manager = std::sync::Arc::new(create_test_manager().await);
        
        let mut handles = vec![];
        for i in 0..10 {
            let mgr = manager.clone();
            let handle = tokio::spawn(async move {
                mgr.create_wallet(&format!("wallet_{}", i), false).await
            });
            handles.push(handle);
        }
        
        let results: Vec<_> = futures::future::join_all(handles).await;
        let successes = results.iter()
            .filter(|r| r.is_ok() && r.as_ref().unwrap().is_ok())
            .count();
        
        assert_eq!(successes, 10, "10个并发创建应该全部成功");
    }
}
EOF
```

#### 运行测试
```bash
cargo test wallet_core_priority_tests
```

#### 检查覆盖率
```bash
cargo tarpaulin --out Html --output-dir coverage
# 打开 coverage/index.html
```

**预期结果**: 覆盖率从 ~65% → ~75%

---

### **Day 3: 加密签名测试**

#### 创建测试文件
```bash
cat > tests/week1_crypto_signing_tests.rs << 'EOF'
//! Week 1: 加密签名优先级测试

#[cfg(test)]
mod crypto_signing_priority_tests {
    use defi_hot_wallet::crypto::signing::*;
    use defi_hot_wallet::test_env;
    
    #[test]
    fn test_sign_ethereum_message() {
        test_env::set_test_env();
        // 签名测试
        assert!(true); // TODO: 实现
    }
    
    #[test]
    fn test_verify_signature() {
        test_env::set_test_env();
        // 验证测试
        assert!(true); // TODO: 实现
    }
    
    #[test]
    fn test_signature_deterministic() {
        test_env::set_test_env();
        // 确定性测试
        assert!(true); // TODO: 实现
    }
}
EOF

cargo test crypto_signing_priority_tests
```

**预期结果**: 覆盖率从 ~75% → ~78%

---

### **Day 4: API认证测试**

```bash
cat > tests/week1_api_auth_tests.rs << 'EOF'
//! Week 1: API认证优先级测试

#[cfg(test)]
mod api_auth_priority_tests {
    use axum_test::TestServer;
    use defi_hot_wallet::api::server::WalletServer;
    use defi_hot_wallet::test_env;
    
    #[tokio::test]
    async fn test_missing_auth_header_returns_401() {
        test_env::set_test_env();
        // TODO: 实现测试
        assert!(true);
    }
    
    #[tokio::test]
    async fn test_invalid_api_key_returns_401() {
        test_env::set_test_env();
        // TODO: 实现测试
        assert!(true);
    }
    
    #[tokio::test]
    async fn test_valid_api_key_returns_200() {
        test_env::set_test_env();
        // TODO: 实现测试
        assert!(true);
    }
}
EOF

cargo test api_auth_priority_tests
```

**预期结果**: 覆盖率从 ~78% → ~80%+

---

## 📋 每日检查清单

### ✅ Day 1
- [ ] 创建 `tests/week1_wallet_core_tests.rs`
- [ ] 实现 5个 钱包创建测试
- [ ] 实现 2个 钱包删除测试
- [ ] 运行测试确保全部通过
- [ ] 检查覆盖率 (目标 ~72%)

### ✅ Day 2
- [ ] 添加 2个 钱包列表测试
- [ ] 添加 1个 并发创建测试
- [ ] 运行所有测试
- [ ] 检查覆盖率 (目标 ~75%)

### ✅ Day 3
- [ ] 创建 `tests/week1_crypto_signing_tests.rs`
- [ ] 实现签名和验证测试
- [ ] 检查覆盖率 (目标 ~78%)

### ✅ Day 4
- [ ] 创建 `tests/week1_api_auth_tests.rs`
- [ ] 实现认证测试
- [ ] 检查覆盖率 (目标 ~80%)

### ✅ Day 5 (复审)
- [ ] 运行全部测试: `cargo test`
- [ ] 生成覆盖率报告
- [ ] 确认 Week 1 目标达成 (80%+)
- [ ] 提交代码

---

## 🛠️ 常用命令

```bash
# 运行所有测试
cargo test

# 运行单个测试
cargo test wallet_core_priority_tests

# 生成覆盖率报告
cargo tarpaulin --out Html --output-dir coverage

# 查看详细输出
cargo test -- --nocapture

# 运行特定测试
cargo test test_create_wallet_success

# 并发测试
cargo test -- --test-threads=1  # 单线程
cargo test -- --test-threads=20 # 20线程
```

---

## 📊 覆盖率目标

```
Day     完成任务                    覆盖率    提升
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Day 0   (当前状态)                  65%     -
Day 1   钱包创建/删除测试(5个)       72%     +7%
Day 2   钱包列表/并发测试(3个)       75%     +3%
Day 3   加密签名测试(8个)            78%     +3%
Day 4   API认证测试(6个)             80%     +2%
Day 5   复审和整理                   80%+    -
```

---

## 🎊 成功标准

Week 1 结束时:
- ✅ 总覆盖率 ≥ 80%
- ✅ 核心钱包模块 ≥ 90%
- ✅ 至少 22个 新测试
- ✅ 所有测试通过
- ✅ HTML覆盖率报告生成

---

## 🚀 现在就开始！

```bash
cd ~/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet

# 创建第一个测试文件
# ... (复制上面的代码)

# 运行测试
cargo test

# 查看结果
echo "开始你的测试之旅！"
```

**好运！Week 1 见！** 🎯

