# 🧪 前端集成测试指南

## 📋 测试清单

### ✅ 基础连接测试

#### 1. 健康检查
```javascript
// 测试后端服务器是否运行
const testHealth = async () => {
  try {
    const response = await fetch('http://localhost:8888/api/health');
    const data = await response.json();
    console.log('✅ 健康检查:', data);
    return data.status === 'healthy';
  } catch (error) {
    console.error('❌ 健康检查失败:', error);
    return false;
  }
};
```

#### 2. CORS验证
```javascript
// 测试跨域请求是否正常
const testCORS = async () => {
  try {
    const response = await fetch('http://localhost:8888/api/wallets', {
      method: 'GET',
      headers: {
        'Authorization': 'test_api_key',
        'Content-Type': 'application/json'
      }
    });
    console.log('✅ CORS正常, 状态码:', response.status);
    return true;
  } catch (error) {
    console.error('❌ CORS错误:', error);
    return false;
  }
};
```

---

### ✅ 认证测试

#### 1. 无认证请求（应该失败）
```javascript
const testNoAuth = async () => {
  try {
    const response = await fetch('http://localhost:8888/api/wallets');
    console.log('状态码:', response.status);
    
    if (response.status === 401) {
      console.log('✅ 无认证请求正确返回401');
      return true;
    } else {
      console.error('❌ 应该返回401，但返回了', response.status);
      return false;
    }
  } catch (error) {
    console.error('❌ 请求失败:', error);
    return false;
  }
};
```

#### 2. 有认证请求（应该成功）
```javascript
const testWithAuth = async () => {
  try {
    const response = await fetch('http://localhost:8888/api/wallets', {
      headers: {
        'Authorization': 'test_api_key'
      }
    });
    
    if (response.status === 200) {
      console.log('✅ 认证请求成功');
      const data = await response.json();
      console.log('钱包列表:', data);
      return true;
    } else {
      console.error('❌ 认证请求失败，状态码:', response.status);
      return false;
    }
  } catch (error) {
    console.error('❌ 请求失败:', error);
    return false;
  }
};
```

#### 3. 动态API Key测试
```javascript
const testDynamicAPIKey = async () => {
  // 设置自定义API Key
  localStorage.setItem('api_key', 'custom_key');
  
  // 使用walletService（会自动读取localStorage）
  try {
    await walletService.listWallets();
    console.log('❌ 应该认证失败，但成功了');
    return false;
  } catch (error) {
    if (error.status === 401) {
      console.log('✅ 自定义API Key正确触发认证失败');
      
      // 恢复默认API Key
      localStorage.removeItem('api_key');
      return true;
    }
  }
};
```

---

### ✅ 钱包操作测试

#### 1. 创建钱包
```javascript
const testCreateWallet = async () => {
  const walletName = `test_wallet_${Date.now()}`;
  
  try {
    const wallet = await walletService.createWallet({
      name: walletName,
      quantum_safe: false
    });
    
    console.log('✅ 创建钱包成功:', wallet);
    
    // 验证响应格式
    if (wallet.id && wallet.name === walletName && wallet.quantum_safe === false) {
      console.log('✅ 响应格式正确');
      return { success: true, walletName };
    } else {
      console.error('❌ 响应格式错误');
      return { success: false };
    }
  } catch (error) {
    console.error('❌ 创建钱包失败:', error);
    return { success: false };
  }
};
```

#### 2. 列出钱包
```javascript
const testListWallets = async () => {
  try {
    const response = await walletService.listWallets();
    console.log('✅ 获取钱包列表成功:', response);
    
    // 验证响应格式
    if (response.wallets && Array.isArray(response.wallets)) {
      console.log('✅ 响应格式正确，钱包数量:', response.wallets.length);
      return { success: true, wallets: response.wallets };
    } else {
      console.error('❌ 响应格式错误');
      return { success: false };
    }
  } catch (error) {
    console.error('❌ 获取钱包列表失败:', error);
    return { success: false };
  }
};
```

#### 3. 获取余额（默认eth网络）
```javascript
const testGetBalanceDefault = async (walletName) => {
  try {
    // 不传网络参数，应该默认使用eth
    const balance = await walletService.getBalance(walletName);
    
    console.log('✅ 获取余额成功:', balance);
    
    // 验证响应格式
    if (balance.balance && balance.network && balance.symbol) {
      console.log('✅ 响应格式正确');
      console.log('  余额:', balance.balance);
      console.log('  网络:', balance.network);
      console.log('  符号:', balance.symbol);
      
      if (balance.network === 'eth') {
        console.log('✅ 默认网络正确为eth');
        return { success: true };
      } else {
        console.error('❌ 默认网络应该是eth，但是', balance.network);
        return { success: false };
      }
    } else {
      console.error('❌ 响应格式错误');
      return { success: false };
    }
  } catch (error) {
    console.error('⚠️  获取余额失败（可能需要区块链客户端）:', error);
    // 即使失败，也可能是正常的（没有配置区块链客户端）
    return { success: true, warning: '需要区块链客户端配置' };
  }
};
```

#### 4. 获取余额（指定网络）
```javascript
const testGetBalanceWithNetwork = async (walletName) => {
  const networks = ['eth', 'solana', 'polygon', 'bsc'];
  
  for (const network of networks) {
    try {
      const balance = await walletService.getBalance(walletName, network);
      console.log(`✅ 获取${network}余额成功:`, balance);
      
      if (balance.network === network) {
        console.log(`✅ 网络参数正确传递: ${network}`);
      } else {
        console.error(`❌ 期望网络${network}，但返回${balance.network}`);
        return { success: false };
      }
    } catch (error) {
      console.log(`⚠️  ${network}网络获取失败（可能需要配置）:`, error.message);
    }
  }
  
  return { success: true };
};
```

#### 5. 发送交易（默认网络）
```javascript
const testSendTransactionDefault = async (walletName) => {
  try {
    const tx = await walletService.sendTransaction(walletName, {
      to_address: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
      amount: '0.001'
      // 不传network，应该默认使用eth
    });
    
    console.log('✅ 发送交易成功:', tx);
    
    // 验证响应格式
    if (tx.tx_hash && tx.status) {
      console.log('✅ 响应格式正确');
      console.log('  交易哈希:', tx.tx_hash);
      console.log('  状态:', tx.status);
      return { success: true, txHash: tx.tx_hash };
    } else {
      console.error('❌ 响应格式错误');
      return { success: false };
    }
  } catch (error) {
    console.error('⚠️  发送交易失败（可能需要区块链客户端）:', error);
    return { success: true, warning: '需要区块链客户端配置' };
  }
};
```

#### 6. 发送交易（指定网络）
```javascript
const testSendTransactionWithNetwork = async (walletName) => {
  try {
    const tx = await walletService.sendTransaction(walletName, {
      to_address: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
      amount: '0.001',
      network: 'sepolia'
    });
    
    console.log('✅ 发送交易（sepolia）成功:', tx);
    return { success: true };
  } catch (error) {
    console.error('⚠️  发送交易失败:', error);
    return { success: true, warning: '需要区块链客户端配置' };
  }
};
```

#### 7. 获取交易历史
```javascript
const testGetHistory = async (walletName) => {
  try {
    const history = await walletService.getTransactionHistory(walletName);
    
    console.log('✅ 获取交易历史成功:', history);
    
    // 验证响应格式
    if (history.transactions && Array.isArray(history.transactions)) {
      console.log('✅ 响应格式正确，交易数量:', history.transactions.length);
      return { success: true };
    } else {
      console.error('❌ 响应格式错误');
      return { success: false };
    }
  } catch (error) {
    console.error('⚠️  获取交易历史失败:', error);
    return { success: true, warning: '可能是空历史' };
  }
};
```

#### 8. 删除钱包
```javascript
const testDeleteWallet = async (walletName) => {
  try {
    await walletService.deleteWallet(walletName);
    console.log('✅ 删除钱包成功');
    return { success: true };
  } catch (error) {
    console.error('❌ 删除钱包失败:', error);
    return { success: false };
  }
};
```

---

### ✅ 错误处理测试

#### 1. 无效网络测试
```javascript
const testInvalidNetwork = async (walletName) => {
  try {
    await walletService.getBalance(walletName, 'invalid_network');
    console.error('❌ 应该抛出错误，但成功了');
    return { success: false };
  } catch (error) {
    if (error.status === 400) {
      console.log('✅ 无效网络正确返回400错误');
      console.log('  错误信息:', error.message);
      return { success: true };
    } else {
      console.error('❌ 应该返回400，但返回', error.status);
      return { success: false };
    }
  }
};
```

#### 2. 不存在的钱包测试
```javascript
const testNonexistentWallet = async () => {
  try {
    await walletService.getBalance('nonexistent_wallet_12345');
    console.error('❌ 应该抛出错误，但成功了');
    return { success: false };
  } catch (error) {
    if (error.status === 404) {
      console.log('✅ 不存在的钱包正确返回404错误');
      console.log('  错误信息:', error.message);
      return { success: true };
    } else {
      console.error('❌ 应该返回404，但返回', error.status);
      return { success: false };
    }
  }
};
```

#### 3. 超时测试
```javascript
const testTimeout = async () => {
  // 临时修改超时时间为1ms来测试超时处理
  const originalTimeout = walletService.axiosInstance.defaults.timeout;
  walletService.axiosInstance.defaults.timeout = 1;
  
  try {
    await walletService.listWallets();
    console.error('❌ 应该超时，但成功了');
    return { success: false };
  } catch (error) {
    if (error.message && error.message.includes('超时')) {
      console.log('✅ 超时处理正确');
      console.log('  错误信息:', error.message);
      return { success: true };
    } else {
      console.error('❌ 超时错误处理不正确');
      return { success: false };
    }
  } finally {
    // 恢复原始超时时间
    walletService.axiosInstance.defaults.timeout = originalTimeout;
  }
};
```

---

### ✅ 速率限制测试

```javascript
const testRateLimit = async () => {
  console.log('🔄 开始速率限制测试（可能需要几秒）...');
  
  const requests = [];
  // 发送150个请求（超过100请求/分钟的限制）
  for (let i = 0; i < 150; i++) {
    requests.push(
      walletService.listWallets().catch(err => err)
    );
  }
  
  const results = await Promise.all(requests);
  
  // 检查是否有429错误
  const rateLimitErrors = results.filter(
    r => r.status === 429
  );
  
  if (rateLimitErrors.length > 0) {
    console.log('✅ 速率限制触发，返回429错误');
    console.log('  触发次数:', rateLimitErrors.length);
    return { success: true };
  } else {
    console.log('⚠️  未触发速率限制（可能请求太慢）');
    return { success: true, warning: '未触发' };
  }
};
```

---

## 🚀 完整测试流程

```javascript
const runAllTests = async () => {
  console.log('🧪 开始前端集成测试...\n');
  
  const results = {
    passed: 0,
    failed: 0,
    warnings: 0
  };
  
  // 1. 基础连接
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('📡 基础连接测试');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  if (await testHealth()) results.passed++; else results.failed++;
  if (await testCORS()) results.passed++; else results.failed++;
  
  // 2. 认证测试
  console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('🔐 认证测试');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  if (await testNoAuth()) results.passed++; else results.failed++;
  if (await testWithAuth()) results.passed++; else results.failed++;
  if (await testDynamicAPIKey()) results.passed++; else results.failed++;
  
  // 3. 钱包操作
  console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('💼 钱包操作测试');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  const { success: createSuccess, walletName } = await testCreateWallet();
  if (createSuccess) results.passed++; else results.failed++;
  
  if (walletName) {
    const { success: listSuccess } = await testListWallets();
    if (listSuccess) results.passed++; else results.failed++;
    
    const { success: balanceSuccess, warning: balanceWarning } = 
      await testGetBalanceDefault(walletName);
    if (balanceSuccess) {
      if (balanceWarning) results.warnings++;
      results.passed++;
    } else {
      results.failed++;
    }
    
    const { success: networkSuccess } = 
      await testGetBalanceWithNetwork(walletName);
    if (networkSuccess) results.passed++; else results.failed++;
    
    const { success: historySuccess } = await testGetHistory(walletName);
    if (historySuccess) results.passed++; else results.failed++;
    
    const { success: deleteSuccess } = await testDeleteWallet(walletName);
    if (deleteSuccess) results.passed++; else results.failed++;
  }
  
  // 4. 错误处理
  console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('⚠️  错误处理测试');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  // 先创建一个测试钱包用于错误测试
  const { walletName: errorTestWallet } = await testCreateWallet();
  
  if (errorTestWallet) {
    const { success: invalidNetworkSuccess } = 
      await testInvalidNetwork(errorTestWallet);
    if (invalidNetworkSuccess) results.passed++; else results.failed++;
    
    await testDeleteWallet(errorTestWallet);
  }
  
  const { success: nonexistentSuccess } = await testNonexistentWallet();
  if (nonexistentSuccess) results.passed++; else results.failed++;
  
  // 5. 总结
  console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('📊 测试总结');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  console.log(`✅ 通过: ${results.passed}`);
  console.log(`❌ 失败: ${results.failed}`);
  console.log(`⚠️  警告: ${results.warnings}`);
  
  const total = results.passed + results.failed;
  const passRate = ((results.passed / total) * 100).toFixed(1);
  
  console.log(`\n通过率: ${passRate}%`);
  
  if (results.failed === 0) {
    console.log('\n🎉 所有测试通过！前后端对接成功！');
  } else {
    console.log('\n⚠️  部分测试失败，请检查配置');
  }
};

// 在浏览器控制台运行
runAllTests();
```

---

## 📝 使用说明

### 1. 在React组件中运行测试
```javascript
import { useEffect } from 'react';
import { walletService } from './services/api';

function TestComponent() {
  useEffect(() => {
    // 运行完整测试套件
    runAllTests();
  }, []);
  
  return <div>查看控制台输出...</div>;
}
```

### 2. 在浏览器控制台直接运行
```javascript
// 打开开发者工具
// 粘贴测试代码
// 运行 runAllTests()
```

### 3. 集成到Jest测试
```javascript
describe('后端API集成测试', () => {
  test('健康检查', async () => {
    const result = await testHealth();
    expect(result).toBe(true);
  });
  
  test('认证机制', async () => {
    const result = await testNoAuth();
    expect(result).toBe(true);
  });
  
  // ... 更多测试
});
```

---

## 🎯 预期结果

### 正常情况
```
✅ 健康检查: { status: 'healthy' }
✅ CORS正常, 状态码: 200
✅ 无认证请求正确返回401
✅ 认证请求成功
✅ 创建钱包成功
✅ 响应格式正确
✅ 默认网络正确为eth
...
🎉 所有测试通过！前后端对接成功！
```

### 需要配置区块链客户端
```
⚠️  获取余额失败（可能需要区块链客户端）
⚠️  发送交易失败（可能需要区块链客户端）
...
通过率: 85.7%
⚠️  部分测试失败，请检查配置
```

这是正常的，因为某些功能需要配置实际的区块链客户端。

---

## 📞 问题排查

### CORS错误
- 确认后端运行在 `http://localhost:8888`
- 确认前端运行在 `http://localhost:3000`
- 检查后端CORS配置

### 认证失败
- 确认API Key为 `test_api_key`
- 检查请求头是否包含 `Authorization`
- 查看localStorage是否设置了自定义api_key

### 连接拒绝
- 确认后端服务器已启动
- 检查端口号是否正确
- 验证防火墙设置

---

**文档版本**: v1.0
**最后更新**: 2025-10-24

