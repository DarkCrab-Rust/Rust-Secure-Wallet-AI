# 📊 测试覆盖率优先级执行计划

基于当前代码结构和业务重要性，制定精确的测试补充计划。

---

## 🎯 总体目标

```
当前估计覆盖率: ~65%
目标覆盖率:     90%+
执行周期:       3周
```

---

## 🔥 **P0 - 最高优先级（Week 1，必须完成）**

### **1. 核心钱包管理模块** 
**重要性**: ⭐⭐⭐⭐⭐  
**当前覆盖率估计**: ~70%  
**目标**: 95%+

**测试文件**: `tests/wallet_core_priority_tests.rs`

```rust
//! Week 1, Day 1-2: 钱包核心功能测试

#[cfg(test)]
mod wallet_core_tests {
    use defi_hot_wallet::core::wallet_manager::WalletManager;
    use defi_hot_wallet::core::config::WalletConfig;
    use defi_hot_wallet::test_env;
    
    // === 钱包创建测试 ===
    
    #[tokio::test]
    async fn test_create_wallet_normal() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        let result = manager.create_wallet("test_wallet", false).await;
        assert!(result.is_ok());
    }
    
    #[tokio::test]
    async fn test_create_wallet_duplicate_name() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        manager.create_wallet("duplicate", false).await.unwrap();
        let result = manager.create_wallet("duplicate", false).await;
        assert!(result.is_err());
    }
    
    #[tokio::test]
    async fn test_create_wallet_invalid_names() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        // 空名称
        assert!(manager.create_wallet("", false).await.is_err());
        
        // 特殊字符
        assert!(manager.create_wallet("wallet-name", false).await.is_err());
        assert!(manager.create_wallet("wallet name", false).await.is_err());
        assert!(manager.create_wallet("wallet@123", false).await.is_err());
        
        // 过长名称
        let long_name = "a".repeat(256);
        assert!(manager.create_wallet(&long_name, false).await.is_err());
    }
    
    #[tokio::test]
    async fn test_create_wallet_quantum_safe() {
        test_env::set_test_env();
        let mut config = WalletConfig::default();
        config.quantum_safe = true;
        let manager = WalletManager::new(&config).await.unwrap();
        
        let result = manager.create_wallet("quantum_wallet", true).await;
        assert!(result.is_ok());
    }
    
    // === 钱包删除测试 ===
    
    #[tokio::test]
    async fn test_delete_wallet_success() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        manager.create_wallet("to_delete", false).await.unwrap();
        let result = manager.delete_wallet("to_delete").await;
        assert!(result.is_ok());
    }
    
    #[tokio::test]
    async fn test_delete_nonexistent_wallet() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        let result = manager.delete_wallet("nonexistent").await;
        assert!(result.is_err());
    }
    
    // === 钱包列表测试 ===
    
    #[tokio::test]
    async fn test_list_wallets_empty() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        let wallets = manager.list_wallets().await.unwrap();
        assert_eq!(wallets.len(), 0);
    }
    
    #[tokio::test]
    async fn test_list_wallets_multiple() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = WalletManager::new(&config).await.unwrap();
        
        manager.create_wallet("wallet1", false).await.unwrap();
        manager.create_wallet("wallet2", false).await.unwrap();
        manager.create_wallet("wallet3", false).await.unwrap();
        
        let wallets = manager.list_wallets().await.unwrap();
        assert_eq!(wallets.len(), 3);
    }
    
    // === 并发测试 ===
    
    #[tokio::test]
    async fn test_concurrent_wallet_creation() {
        test_env::set_test_env();
        let config = WalletConfig::default();
        let manager = std::sync::Arc::new(WalletManager::new(&config).await.unwrap());
        
        let mut handles = vec![];
        for i in 0..10 {
            let mgr = manager.clone();
            handles.push(tokio::spawn(async move {
                mgr.create_wallet(&format!("wallet_{}", i), false).await
            }));
        }
        
        let results: Vec<_> = futures::future::join_all(handles).await;
        let successes = results.iter().filter(|r| r.is_ok() && r.as_ref().unwrap().is_ok()).count();
        assert_eq!(successes, 10);
    }
}
```

**执行步骤**：
```bash
# 创建测试文件
# 运行测试
cargo test wallet_core_tests --lib

# 检查覆盖率
cargo tarpaulin --packages defi-hot-wallet --lib \
  --exclude-files 'target/*' 'tests/*' \
  -- wallet_core_tests
```

**预期提升**: +10-15%

---

### **2. 加密模块（签名和验证）**
**重要性**: ⭐⭐⭐⭐⭐  
**当前覆盖率估计**: ~60%  
**目标**: 90%+

**测试文件**: `tests/crypto_signing_priority_tests.rs`

```rust
//! Week 1, Day 3: 加密签名测试

#[cfg(test)]
mod crypto_signing_tests {
    use defi_hot_wallet::crypto::*;
    use secp256k1::SecretKey;
    
    #[test]
    fn test_sign_ethereum_transaction() {
        // 以太坊交易签名
    }
    
    #[test]
    fn test_verify_ethereum_signature() {
        // 签名验证
    }
    
    #[test]
    fn test_sign_with_invalid_key() {
        // 无效密钥签名应失败
    }
    
    #[test]
    fn test_signature_deterministic() {
        // 相同输入应产生相同签名
    }
    
    #[test]
    fn test_recovery_from_signature() {
        // 从签名恢复公钥
    }
}
```

**预期提升**: +8-10%

---

### **3. API认证和授权**
**重要性**: ⭐⭐⭐⭐⭐  
**当前覆盖率估计**: ~75%  
**目标**: 95%+

**测试文件**: `tests/api_auth_priority_tests.rs`

```rust
//! Week 1, Day 4: API认证测试

#[cfg(test)]
mod api_auth_tests {
    use axum_test_helper::TestClient;
    
    #[tokio::test]
    async fn test_auth_missing_header() {
        // 缺少Authorization头应返回401
    }
    
    #[tokio::test]
    async fn test_auth_invalid_api_key() {
        // 错误的API Key应返回401
    }
    
    #[tokio::test]
    async fn test_auth_valid_api_key() {
        // 正确的API Key应返回200
    }
    
    #[tokio::test]
    async fn test_rate_limiting() {
        // 超过速率限制应返回429
    }
}
```

**预期提升**: +5-7%

---

## 🔶 **P1 - 高优先级（Week 2）**

### **4. 存储层（数据库操作）**
**重要性**: ⭐⭐⭐⭐  
**当前覆盖率估计**: ~65%  
**目标**: 90%+

**测试文件**: `tests/storage_priority_tests.rs`

```rust
//! Week 2, Day 1-2: 存储层测试

#[cfg(test)]
mod storage_tests {
    #[tokio::test]
    async fn test_wallet_persistence() {
        // 钱包持久化
    }
    
    #[tokio::test]
    async fn test_transaction_storage() {
        // 交易存储
    }
    
    #[tokio::test]
    async fn test_concurrent_writes() {
        // 并发写入
    }
    
    #[tokio::test]
    async fn test_data_integrity() {
        // 数据完整性
    }
    
    #[tokio::test]
    async fn test_audit_log_storage() {
        // 审计日志存储
    }
}
```

**预期提升**: +6-8%

---

### **5. API端点完整性**
**重要性**: ⭐⭐⭐⭐  
**当前覆盖率估计**: ~70%  
**目标**: 95%+

**测试文件**: `tests/api_endpoints_comprehensive_tests.rs`

```rust
//! Week 2, Day 3-4: API端点测试

#[cfg(test)]
mod api_endpoints_tests {
    // 每个端点测试 5-6 个场景
    
    #[tokio::test]
    async fn test_create_wallet_endpoint_success() {}
    
    #[tokio::test]
    async fn test_create_wallet_endpoint_duplicate() {}
    
    #[tokio::test]
    async fn test_create_wallet_endpoint_invalid_params() {}
    
    #[tokio::test]
    async fn test_create_wallet_endpoint_unauthorized() {}
    
    #[tokio::test]
    async fn test_create_wallet_endpoint_rate_limited() {}
    
    // ... 对每个端点重复
    // - GET /api/wallets
    // - DELETE /api/wallets/:name
    // - GET /api/wallets/:name/balance
    // - POST /api/wallets/:name/send
    // - GET /api/wallets/:name/history
    // - POST /api/bridge
}
```

**预期提升**: +7-9%

---

### **6. 密钥管理和轮换**
**重要性**: ⭐⭐⭐⭐  
**当前覆盖率估计**: ~50%  
**目标**: 85%+

**测试文件**: `tests/key_management_tests.rs`

```rust
//! Week 2, Day 5: 密钥管理测试

#[cfg(test)]
mod key_management_tests {
    #[tokio::test]
    async fn test_key_derivation_bip32() {
        // BIP32密钥派生
    }
    
    #[tokio::test]
    async fn test_key_derivation_bip44() {
        // BIP44路径测试
    }
    
    #[tokio::test]
    async fn test_key_rotation() {
        // 密钥轮换
    }
    
    #[tokio::test]
    async fn test_key_zeroization() {
        // 内存清零验证
    }
    
    #[tokio::test]
    async fn test_master_key_derivation_consistency() {
        // 主密钥派生一致性
    }
}
```

**预期提升**: +5-7%

---

## 🔷 **P2 - 中优先级（Week 3）**

### **7. 区块链交互模块**
**重要性**: ⭐⭐⭐  
**当前覆盖率估计**: ~45%  
**目标**: 75%+

```rust
//! Week 3, Day 1-2: 区块链模块测试

#[cfg(test)]
mod blockchain_tests {
    #[tokio::test]
    async fn test_ethereum_client_mock() {
        // 以太坊客户端模拟测试
    }
    
    #[tokio::test]
    async fn test_solana_client_mock() {
        // Solana客户端模拟测试
    }
    
    #[tokio::test]
    async fn test_transaction_broadcasting() {
        // 交易广播（模拟）
    }
    
    #[tokio::test]
    async fn test_balance_query_fallback() {
        // 余额查询失败处理
    }
}
```

**预期提升**: +4-6%

---

### **8. 边界条件和错误处理**
**重要性**: ⭐⭐⭐  
**当前覆盖率估计**: ~50%  
**目标**: 80%+

```rust
//! Week 3, Day 3: 边界条件测试

#[cfg(test)]
mod edge_cases_tests {
    #[tokio::test]
    async fn test_max_transaction_amount() {
        // U256::MAX 交易金额
    }
    
    #[tokio::test]
    async fn test_zero_amount_transaction() {
        // 零金额交易应失败
    }
    
    #[tokio::test]
    async fn test_invalid_address_formats() {
        // 各种无效地址格式
    }
    
    #[tokio::test]
    async fn test_network_timeout_handling() {
        // 网络超时处理
    }
    
    #[tokio::test]
    async fn test_database_connection_failure() {
        // 数据库连接失败处理
    }
}
```

**预期提升**: +3-5%

---

### **9. 多签名和量子安全**
**重要性**: ⭐⭐⭐  
**当前覆盖率估计**: ~40%  
**目标**: 75%+

```rust
//! Week 3, Day 4: 高级加密功能测试

#[cfg(test)]
mod advanced_crypto_tests {
    #[tokio::test]
    async fn test_multisig_creation() {
        // 多签钱包创建
    }
    
    #[tokio::test]
    async fn test_multisig_signing_flow() {
        // 多签签名流程
    }
    
    #[tokio::test]
    async fn test_quantum_safe_encryption() {
        // 量子安全加密
    }
    
    #[tokio::test]
    async fn test_quantum_safe_decryption() {
        // 量子安全解密
    }
    
    #[tokio::test]
    async fn test_shamir_secret_sharing() {
        // Shamir秘密共享
    }
}
```

**预期提升**: +4-6%

---

### **10. 集成测试**
**重要性**: ⭐⭐⭐  
**当前覆盖率估计**: ~30%  
**目标**: 70%+

```rust
//! Week 3, Day 5: 端到端集成测试

#[cfg(test)]
mod integration_tests {
    #[tokio::test]
    async fn test_complete_wallet_lifecycle() {
        // 1. 创建钱包
        // 2. 查询余额
        // 3. 发送交易
        // 4. 查看历史
        // 5. 备份
        // 6. 删除
    }
    
    #[tokio::test]
    async fn test_multi_wallet_operations() {
        // 多钱包并发操作
    }
    
    #[tokio::test]
    async fn test_bridge_workflow() {
        // 跨链桥接完整流程
    }
}
```

**预期提升**: +3-4%

---

## 📈 覆盖率提升预测

```
Week    模块                      当前    本周目标   累计目标
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Week 1  核心钱包 + 加密 + API认证   65%  →  80%      80%
Week 2  存储 + API端点 + 密钥管理   80%  →  87%      87%
Week 3  区块链 + 边界 + 高级功能    87%  →  92%      92%+
```

---

## 🎯 执行检查清单

### Week 1
- [ ] Day 1: 钱包创建/删除测试（10个测试）
- [ ] Day 2: 钱包列表/并发测试（5个测试）
- [ ] Day 3: 加密签名测试（8个测试）
- [ ] Day 4: API认证测试（6个测试）
- [ ] Day 5: 覆盖率检查，目标80%

### Week 2
- [ ] Day 1-2: 存储层测试（12个测试）
- [ ] Day 3-4: API端点测试（30个测试）
- [ ] Day 5: 密钥管理测试（10个测试），目标87%

### Week 3
- [ ] Day 1-2: 区块链模块测试（8个测试）
- [ ] Day 3: 边界条件测试（10个测试）
- [ ] Day 4: 高级加密测试（10个测试）
- [ ] Day 5: 集成测试（5个测试），最终目标92%+

---

## 🛠️ 每日工作流程

```bash
# 1. 开始工作
cd ~/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet

# 2. 创建/编辑测试文件
# vim tests/wallet_core_priority_tests.rs

# 3. 运行新测试
cargo test wallet_core_tests

# 4. 检查覆盖率
cargo tarpaulin --out Html --output-dir coverage

# 5. 查看报告
# 打开 coverage/index.html

# 6. 提交代码
git add tests/
git commit -m "test: add wallet core priority tests (+12% coverage)"
```

---

## ✅ 成功标准

- [ ] 总体覆盖率 > 90%
- [ ] 核心模块 > 95%
- [ ] API模块 > 95%
- [ ] 加密模块 > 90%
- [ ] 存储模块 > 90%
- [ ] 区块链模块 > 75%
- [ ] 所有测试通过
- [ ] HTML报告生成

---

## 🚀 立即开始

**现在就创建第一个测试文件：**

```bash
# 创建测试文件
cat > tests/wallet_core_priority_tests.rs << 'EOF'
//! 核心钱包功能优先级测试

#[cfg(test)]
mod wallet_core_tests {
    use defi_hot_wallet::test_env;
    
    #[test]
    fn test_placeholder() {
        test_env::set_test_env();
        assert!(true);
    }
}
EOF

# 运行测试
cargo test wallet_core_tests

# 开始添加实际测试...
```

**祝测试顺利！3周后见！** 🎯

