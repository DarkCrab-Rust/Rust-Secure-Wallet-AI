# 🔧 前后端联调故障处理指南

> **前端固定端口**: `3010`  
> **后端固定端口**: `8888`

---

## 🎯 快速诊断流程

```
前端无法连接后端
    ↓
1. 检查CORS配置 → 是否允许 http://localhost:3010?
    ↓
2. 检查API Key → 是否正确配置?
    ↓
3. 检查端口冲突 → 3010端口是否被占用?
    ↓
4. 检查后端状态 → 8888端口是否正常运行?
```

---

## ❌ 故障1: CORS错误

### 🔍 错误表现

浏览器控制台显示:

```
Access to XMLHttpRequest at 'http://localhost:8888/api/wallets' 
from origin 'http://localhost:3010' has been blocked by CORS policy
```

或:

```
No 'Access-Control-Allow-Origin' header is present
```

---

### ✅ 解决方案

#### 方案1: 配置后端允许3010端口 (推荐)

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet"

# 配置CORS允许3010
export CORS_ALLOW_ORIGIN="http://localhost:3010"

# 重启后端
bash restart_server.sh
```

#### 方案2: 同时允许3000和3010 (开发环境推荐)

```bash
# 同时支持后端测试(3000)和前端开发(3010)
export CORS_ALLOW_ORIGIN="http://localhost:3000,http://localhost:3010"

bash restart_server.sh
```

#### 方案3: 使用一键启动脚本

```bash
bash start_fullstack.sh
# 选择 "2. 启动后端+前端"
# 会自动配置CORS为3010
```

---

### 🔍 验证CORS配置

```bash
# 查看服务器日志
bash view_server_logs.sh

# 应该看到:
# INFO: CORS configured to allow origin: http://localhost:3010
```

或者测试CORS请求:

```bash
curl -v -X OPTIONS http://localhost:8888/api/health \
  -H "Origin: http://localhost:3010" \
  -H "Access-Control-Request-Method: GET"

# 应该返回:
# < Access-Control-Allow-Origin: http://localhost:3010
```

---

## ❌ 故障2: API Key认证失败

### 🔍 错误表现

浏览器控制台或网络请求显示:

```json
{
  "error": "Unauthorized",
  "code": "AUTH_FAILED"
}
```

或前端显示:
```
加载钱包列表失败
```

---

### ✅ 解决方案

#### 方案1: 在浏览器控制台设置API Key (推荐)

1. **打开浏览器**: 访问 `http://localhost:3010`
2. **打开控制台**: 按 `F12` 键
3. **执行以下命令**:

```javascript
// 设置API Key
localStorage.setItem('api_key', 'testnet_api_key_51a69b550a2c4149');

// 设置API URL
localStorage.setItem('api_url', 'http://localhost:8888');

// 刷新页面
location.reload();
```

---

#### 方案2: 配置前端环境文件

创建 `Wallet front-end/blockchain-wallet-ui/.env.local`:

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Wallet front-end/blockchain-wallet-ui"

cat > .env.local << 'EOF'
PORT=3010
REACT_APP_API_URL=http://localhost:8888
REACT_APP_API_KEY=testnet_api_key_51a69b550a2c4149
REACT_APP_DEFAULT_NETWORK=eth
REACT_APP_ENABLE_TESTNET=true
REACT_APP_ENV=development
EOF

# 重启前端
npm start
```

或使用脚本:

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet"
bash create_frontend_env.sh
```

---

#### 方案3: 检查前端代码

确认 `src/services/api.ts` 中的API Key配置:

```typescript
const API_KEY = localStorage.getItem('api_key') || 
                process.env.REACT_APP_API_KEY || 
                'testnet_api_key_51a69b550a2c4149';
```

---

### 🔍 验证API Key

#### 后端测试:

```bash
# 正确的API Key
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets

# 应该返回钱包列表 (可能是空数组)
```

#### 前端测试:

1. 打开浏览器控制台 (F12)
2. 切换到 **Network** 标签
3. 刷新页面
4. 查看 `/api/wallets` 请求
5. 检查 **Request Headers** 中的 `Authorization` 字段

应该看到:
```
Authorization: testnet_api_key_51a69b550a2c4149
```

---

## ❌ 故障3: 端口冲突

### 🔍 错误表现

启动前端时显示:

```
? Something is already running on port 3010.
```

或:

```
Error: listen EADDRINUSE: address already in use :::3010
```

---

### ✅ 解决方案

#### 方案1: 杀死占用进程 (推荐)

```bash
# 查找占用3010端口的进程
netstat -ano | findstr :3010

# 输出示例:
# TCP    0.0.0.0:3010    0.0.0.0:0    LISTENING    12345

# 杀死进程 (12345是PID)
taskkill /F /PID 12345
```

#### 方案2: 一键清理脚本

```bash
# 创建清理脚本
cat > kill_port_3010.bat << 'EOF'
@echo off
echo 正在查找占用3010端口的进程...
for /f "tokens=5" %%a in ('netstat -ano ^| findstr :3010') do (
    echo 正在杀死进程 %%a
    taskkill /F /PID %%a
)
echo 完成!
EOF

# 运行脚本
./kill_port_3010.bat
```

---

### 🔍 验证端口状态

```bash
# 检查3010端口
netstat -ano | findstr :3010

# 如果没有输出,说明端口已释放
```

---

## ❌ 故障4: 后端未启动

### 🔍 错误表现

前端显示:
```
Network Error
Failed to fetch
```

浏览器控制台显示:
```
GET http://localhost:8888/api/wallets net::ERR_CONNECTION_REFUSED
```

---

### ✅ 解决方案

#### 方案1: 启动后端

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet"

# 配置CORS为3010
export CORS_ALLOW_ORIGIN="http://localhost:3010"

# 启动后端
bash restart_server.sh
```

#### 方案2: 检查后端状态

```bash
# 查看服务器状态
bash manage_server.sh
# 选择 "1. 查看服务器状态"

# 或直接检查8888端口
netstat -ano | findstr :8888
```

#### 方案3: 查看后端日志

```bash
bash view_server_logs.sh
# 选择 "1. 查看最近日志"
```

---

### 🔍 验证后端状态

```bash
# 测试健康检查
curl http://localhost:8888/api/health

# 应该返回:
# {"status":"ok"}
```

---

## 🎯 完整启动流程 (推荐)

### 方式1: 使用一键启动脚本

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet"

bash start_fullstack.sh
# 选择 "2. 启动后端+前端"
```

**优点**:
- ✅ 自动配置CORS为3010
- ✅ 自动创建前端环境配置
- ✅ 自动启动前后端
- ✅ 提供清晰的配置提示

---

### 方式2: 手动启动

#### 步骤1: 启动后端

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Rust-Blockchain-Secure-Wallet"

# 配置CORS
export CORS_ALLOW_ORIGIN="http://localhost:3010"

# 启动后端
bash restart_server.sh
```

#### 步骤2: 配置前端

```bash
cd "C:/Users/plant/Desktop/Rust区块链/Wallet front-end/blockchain-wallet-ui"

# 创建环境配置
cat > .env.local << 'EOF'
PORT=3010
REACT_APP_API_URL=http://localhost:8888
REACT_APP_API_KEY=testnet_api_key_51a69b550a2c4149
EOF
```

#### 步骤3: 启动前端

```bash
npm start
```

#### 步骤4: 配置浏览器

1. 打开 `http://localhost:3010`
2. 按 `F12` 打开控制台
3. 执行:

```javascript
localStorage.setItem('api_key', 'testnet_api_key_51a69b550a2c4149');
localStorage.setItem('api_url', 'http://localhost:8888');
location.reload();
```

---

## 📋 故障排查检查清单

在报告问题前,请依次检查:

- [ ] **后端是否运行?**
  ```bash
  netstat -ano | findstr :8888
  ```

- [ ] **CORS是否配置为3010?**
  ```bash
  bash view_server_logs.sh
  # 查找: "CORS configured to allow origin: http://localhost:3010"
  ```

- [ ] **前端是否在3010端口?**
  ```bash
  netstat -ano | findstr :3010
  ```

- [ ] **API Key是否正确?**
  - 浏览器F12 → Network → 查看请求头
  - 应该是: `Authorization: testnet_api_key_51a69b550a2c4149`

- [ ] **浏览器localStorage是否配置?**
  - 浏览器F12 → Console → 执行:
  ```javascript
  console.log(localStorage.getItem('api_key'));
  console.log(localStorage.getItem('api_url'));
  ```

---

## 🔍 高级调试

### 查看完整请求流程

1. **打开浏览器开发者工具** (F12)
2. **切换到Network标签**
3. **刷新页面**
4. **点击失败的请求**
5. **查看以下信息**:

#### Request Headers (请求头)
```
Authorization: testnet_api_key_51a69b550a2c4149
Origin: http://localhost:3010
```

#### Response Headers (响应头)
```
Access-Control-Allow-Origin: http://localhost:3010
```

#### Response Body (响应内容)
```json
{
  "error": "Unauthorized",
  "code": "AUTH_FAILED"
}
```

---

### 使用curl测试后端

```bash
# 测试健康检查
curl http://localhost:8888/api/health

# 测试钱包列表 (需要API Key)
curl -H "Authorization: testnet_api_key_51a69b550a2c4149" \
  http://localhost:8888/api/wallets

# 测试CORS预检
curl -v -X OPTIONS http://localhost:8888/api/health \
  -H "Origin: http://localhost:3010" \
  -H "Access-Control-Request-Method: GET"
```

---

## 📞 仍然无法解决?

如果以上方法都无法解决问题,请提供以下信息:

1. **后端状态**:
   ```bash
   bash manage_server.sh
   # 选择 "1. 查看服务器状态"
   ```

2. **后端日志**:
   ```bash
   bash view_server_logs.sh
   # 选择 "1. 查看最近日志"
   ```

3. **前端端口**:
   ```bash
   netstat -ano | findstr :3010
   ```

4. **浏览器控制台错误**:
   - 按F12打开控制台
   - 截图Console和Network标签的错误信息

5. **CORS配置**:
   ```bash
   echo $CORS_ALLOW_ORIGIN
   ```

---

## 📖 相关文档

- `多CORS源配置说明.md` - CORS多源配置
- `CORS配置说明.md` - CORS详细说明
- `后端测试指南.md` - 后端测试方法
- `脚本使用手册.md` - 脚本使用说明

---

**祝你开发顺利!** 🚀

