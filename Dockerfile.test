FROM rust:1.75-bullseye

# Install system dependencies needed for building and for tarpaulin
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    clang \
    llvm \
    libssl-dev \
    pkg-config \
    python3 \
    python3-pip \
    ca-certificates \
    curl \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy repo into the image
COPY . /app

# Install cargo-tarpaulin (may take a while)
RUN cargo install --locked cargo-tarpaulin

# Ensure mock RPC script is executable
RUN chmod +x /app/tools/mock_rpc.py

# Add a helper script to start mock rpc and run coverage
COPY tools/run_tests.sh /usr/local/bin/run_tests.sh
RUN chmod +x /usr/local/bin/run_tests.sh

ENTRYPOINT ["/usr/local/bin/run_tests.sh"]
